<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WKP Waterkwaliteit Viewer v5</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #475569;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .container { display: flex; height: 100vh; }
        
        .sidebar {
            width: 340px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; }
        
        .version {
            background: var(--accent);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .main-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }
        
        .main-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .main-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .main-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: var(--bg-secondary);
        }
        
        .main-panel {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
        }
        
        .main-panel.active {
            display: flex;
        }
        
        /* PDOK Layer styling */
        .pdok-layer-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .pdok-layer-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
        }
        
        .pdok-layer-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .pdok-layer-header input[type="checkbox"] {
            margin-top: 3px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .pdok-layer-meta {
            flex: 1;
        }
        
        .pdok-layer-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .pdok-layer-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            line-height: 1.4;
        }
        
        .pdok-layer-status {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            margin-top: 0.5rem;
        }
        
        .pdok-layer-status.ok {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .pdok-layer-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .pdok-layer-controls {
            margin-top: 0.75rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
        }
        
        .pdok-layer-controls label {
            font-size: 0.7rem;
            margin-bottom: 0.15rem;
        }
        
        .pdok-layer-controls input[type="range"] {
            width: 100%;
            margin-bottom: 0;
        }
        
        .pdok-layer-controls select {
            font-size: 0.75rem;
            padding: 0.35rem;
            margin-bottom: 0;
        }
        
        .pdok-legend {
            min-height: 60px;
        }
        
        .pdok-legend img {
            max-width: 100%;
            display: block;
            border-radius: 4px;
        }
        
        .pdok-legend-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
        }
        
        /* Feature Info Panel */
        .feature-panel {
            position: absolute;
            right: 18px;
            top: 74px;
            width: 360px;
            max-height: calc(100% - 110px);
            overflow: auto;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            padding: 1rem;
            z-index: 999;
            display: none;
        }
        
        .feature-panel h4 {
            margin: 0 0 0.5rem;
            color: var(--accent);
            font-size: 0.95rem;
        }
        
        .feature-panel .feature-sub {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .feature-panel table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .feature-panel td {
            padding: 0.4rem 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            vertical-align: top;
        }
        
        .feature-panel td.k {
            color: var(--text-secondary);
            font-weight: 600;
            width: 40%;
        }
        
        .feature-close {
            float: right;
            border-radius: 6px;
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .feature-close:hover {
            background: var(--border);
        }
        
        .section { border-bottom: 1px solid var(--border); }
        
        .section-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }
        
        .section-header:hover { background: var(--border); }
        .section-header h3 { font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
        .section-content { padding: 1rem; display: none; }
        .section-content.open { display: block; }
        
        label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        
        select, input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }
        
        select:focus, input:focus { outline: none; border-color: var(--accent); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .full-width { grid-column: 1 / -1; }
        
        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #16a34a; }
        
        .btn-group { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .btn-group .btn { flex: 1; min-width: 0; padding: 0.4rem 0.5rem; font-size: 0.75rem; }
        .btn-group .btn.active { background: var(--accent); color: white; }
        
        .geo-tabs { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
        .geo-tab {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .geo-tab:hover { background: var(--bg-tertiary); }
        .geo-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .geo-content { display: none; }
        .geo-content.active { display: block; }
        
        .param-list {
            max-height: 180px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }
        
        .param-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        
        .param-item:last-child { border-bottom: none; }
        .param-item:hover { background: var(--bg-tertiary); }
        .param-item.selected { background: var(--accent); color: white; }
        .param-item .code { font-weight: 600; }
        .param-item .desc { font-size: 0.7rem; color: var(--text-secondary); }
        .param-item.selected .desc { color: rgba(255,255,255,0.7); }
        
        .waterbeheerder-list {
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }
        
        .waterbeheerder-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        
        .waterbeheerder-item:last-child { border-bottom: none; }
        .waterbeheerder-item:hover { background: var(--bg-tertiary); }
        .waterbeheerder-item.selected { background: var(--accent); color: white; }
        .waterbeheerder-item .count { float: right; color: var(--text-secondary); font-size: 0.7rem; }
        .waterbeheerder-item.selected .count { color: rgba(255,255,255,0.7); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem; }
        .stat-box { background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1.25rem; font-weight: 600; color: var(--accent); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
        
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        .header-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }
        
        .header-info { display: flex; align-items: center; gap: 1rem; }
        .header-info .source {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }
        
        .header-actions { display: flex; gap: 0.5rem; }
        
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
        .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .filter-indicator {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }
        .filter-indicator.visible { display: block; }
        
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: rgba(30, 41, 59, 0.95);
            padding: 0.75rem;
            border-radius: 8px;
            z-index: 1000;
            min-width: 150px;
        }
        
        .legend-title { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .legend-scale { display: flex; flex-direction: column; gap: 0.25rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.7rem; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; }
        
        .legend-gradient {
            height: 120px;
            width: 20px;
            background: linear-gradient(to bottom, #ef4444, #f97316, #eab308, #22c55e, #3b82f6);
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        
        .legend-labels { display: flex; flex-direction: column; justify-content: space-between; height: 120px; font-size: 0.7rem; }
        
        .detail-panel {
            position: absolute;
            top: 60px;
            right: 10px;
            width: 400px;
            max-height: calc(100vh - 80px);
            background: var(--bg-secondary);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .detail-panel.visible { display: block; }
        
        .detail-header {
            padding: 1rem;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .detail-header h3 { font-size: 0.95rem; margin-bottom: 0.25rem; }
        .detail-header .code { font-size: 0.75rem; color: var(--text-secondary); }
        
        .detail-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            line-height: 1;
        }
        
        .detail-content { padding: 1rem; max-height: 500px; overflow-y: auto; }
        
        .detail-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .detail-stat { background: var(--bg-primary); padding: 0.5rem; border-radius: 4px; text-align: center; }
        .detail-stat-value { font-size: 0.9rem; font-weight: 600; color: var(--accent); }
        .detail-stat-label { font-size: 0.6rem; color: var(--text-secondary); }
        
        .chart-container { height: 180px; margin-bottom: 1rem; }
        
        .measurements-table {
            width: 100%;
            font-size: 0.75rem;
            border-collapse: collapse;
        }
        
        .measurements-table th, .measurements-table td {
            padding: 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .measurements-table th { color: var(--text-secondary); font-weight: 500; }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-overlay.visible { display: flex; }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text { margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>üíß</span>
                <h1>WKP Waterkwaliteit</h1>
                <span class="version">v5</span>
            </div>
            
            <!-- Hoofdtabs -->
            <div class="main-tabs">
                <div class="main-tab active" id="mainTab-waterkwaliteit" onclick="switchMainTab('waterkwaliteit')">üß™ Waterkwaliteit</div>
                <div class="main-tab" id="mainTab-pdok" onclick="switchMainTab('pdok')">üó∫Ô∏è PDOK Lagen</div>
            </div>
            
            <!-- Waterkwaliteit Panel -->
            <div id="panel-waterkwaliteit" class="main-panel active">
            
            <!-- Parameter selectie -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üß™ Parameter</h3>
                    <span>‚ñº</span>
                </div>
                <div class="section-content open">
                    <label>Selecteer waterkwaliteitsparameter</label>
                    <div class="param-list" id="paramList">
                        <div class="param-item selected" data-code="Ptot" data-unit="mg/L">
                            <span class="code">Ptot</span>
                            <span class="desc">Fosfor totaal (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="PO4" data-unit="mg/L">
                            <span class="code">PO4</span>
                            <span class="desc">Orthofosfaat (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="Ntot" data-unit="mg/L">
                            <span class="code">Ntot</span>
                            <span class="desc">Stikstof totaal (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="NO3" data-unit="mg/L">
                            <span class="code">NO3</span>
                            <span class="desc">Nitraat (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="NH4" data-unit="mg/L">
                            <span class="code">NH4</span>
                            <span class="desc">Ammonium (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="Cl" data-unit="mg/L">
                            <span class="code">Cl</span>
                            <span class="desc">Chloride (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="O2" data-unit="mg/L">
                            <span class="code">O2</span>
                            <span class="desc">Zuurstof (mg/L)</span>
                        </div>
                        <div class="param-item" data-code="pH" data-unit="-">
                            <span class="code">pH</span>
                            <span class="desc">Zuurgraad (-)</span>
                        </div>
                        <div class="param-item" data-code="T" data-unit="¬∞C">
                            <span class="code">T</span>
                            <span class="desc">Temperatuur (¬∞C)</span>
                        </div>
                        <div class="param-item" data-code="GELDHD" data-unit="mS/m">
                            <span class="code">GELDHD</span>
                            <span class="desc">Geleidbaarheid (mS/m)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Geografisch Filter -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üó∫Ô∏è Geografisch Filter</h3>
                    <span>‚ñº</span>
                </div>
                <div class="section-content open">
                    <div class="geo-tabs">
                        <button class="geo-tab active" onclick="setGeoFilter('alles')">Alles</button>
                        <button class="geo-tab" onclick="setGeoFilter('waterschap')">Waterschap</button>
                        <button class="geo-tab" onclick="setGeoFilter('provincie')">Provincie</button>
                        <button class="geo-tab" onclick="setGeoFilter('gemeente')">Gemeente</button>
                    </div>
                    
                    <div id="geoAlles" class="geo-content active">
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">
                            Alle meetlocaties in Nederland worden getoond.
                        </p>
                    </div>
                    
                    <div id="geoWaterschap" class="geo-content">
                        <label>Selecteer waterschap</label>
                        <div class="waterbeheerder-list" id="waterbeheerderList">
                            <div class="waterbeheerder-item" style="color: var(--text-secondary);">
                                Laad eerst locaties...
                            </div>
                        </div>
                    </div>
                    
                    <div id="geoProvincie" class="geo-content">
                        <label>Selecteer provincie</label>
                        <select id="provincieSelect">
                            <option value="">Kies een provincie...</option>
                            <option value="Groningen">Groningen</option>
                            <option value="Frysl√¢n">Frysl√¢n</option>
                            <option value="Drenthe">Drenthe</option>
                            <option value="Overijssel">Overijssel</option>
                            <option value="Flevoland">Flevoland</option>
                            <option value="Gelderland">Gelderland</option>
                            <option value="Utrecht">Utrecht</option>
                            <option value="Noord-Holland">Noord-Holland</option>
                            <option value="Zuid-Holland">Zuid-Holland</option>
                            <option value="Zeeland">Zeeland</option>
                            <option value="Noord-Brabant">Noord-Brabant</option>
                            <option value="Limburg">Limburg</option>
                        </select>
                    </div>
                    
                    <div id="geoGemeente" class="geo-content">
                        <label>Zoek gemeente</label>
                        <input type="text" id="gemeenteSearch" placeholder="Typ om te zoeken...">
                        <select id="gemeenteSelect" size="4" style="height: 100px;">
                            <option value="">Laden...</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-secondary full-width" onclick="applyGeoFilter()">
                        üîç Filter Toepassen
                    </button>
                </div>
            </div>
            
            <!-- Periode -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üìÖ Periode</h3>
                    <span>‚ñº</span>
                </div>
                <div class="section-content open">
                    <div class="form-row">
                        <div>
                            <label>Van jaar</label>
                            <select id="yearFrom"></select>
                        </div>
                        <div>
                            <label>Van maand</label>
                            <select id="monthFrom">
                                <option value="1" selected>Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maart</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Augustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label>Tot jaar</label>
                            <select id="yearTo"></select>
                        </div>
                        <div>
                            <label>Tot maand</label>
                            <select id="monthTo">
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maart</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Augustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12" selected>December</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label>Max. metingen</label>
                        <select id="maxResults">
                            <option value="500">500</option>
                            <option value="1000" selected>1.000</option>
                            <option value="2000">2.000</option>
                            <option value="5000">5.000</option>
                        </select>
                    </div>
                    <div>
                        <label>Max. meetlocaties</label>
                        <select id="maxLocations">
                            <option value="5000">5.000</option>
                            <option value="10000">10.000</option>
                            <option value="20000">20.000</option>
                            <option value="50000" selected>Alle (max 50.000)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Visualisatie -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>üé® Visualisatie</h3>
                    <span>‚ñº</span>
                </div>
                <div class="section-content open">
                    <label>Kleur op basis van (locaties)</label>
                    <div class="btn-group">
                        <button class="btn btn-secondary active" id="btnColorWaterschap" onclick="setLocationColorMode('waterschap')">Waterschap</button>
                        <button class="btn btn-secondary" id="btnColorWatertype" onclick="setLocationColorMode('watertype')">Watertype</button>
                    </div>
                    
                    <label>Kleurschaal (metingen)</label>
                    <div class="btn-group">
                        <button class="btn btn-secondary active" onclick="setColorMode('concentratie')">Concentratie</button>
                        <button class="btn btn-secondary" onclick="setColorMode('percentiel')">Percentiel</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="statLocaties">0</div>
                            <div class="stat-label">Meetpunten</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statWaterschappen">0</div>
                            <div class="stat-label">Waterschappen</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statMetingen">0</div>
                            <div class="stat-label">Metingen</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statGemiddelde">-</div>
                            <div class="stat-label">Gemiddelde</div>
                        </div>
                    </div>
                </div>
            </div>
            </div><!-- Einde panel-waterkwaliteit -->
            
            <!-- PDOK Lagen Panel -->
            <div id="panel-pdok" class="main-panel">
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üåç PDOK Services</h3>
                        <span>‚ñº</span>
                    </div>
                    <div class="section-content open">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">
                            PDOK-lagen (KRW & waterschappen), dynamisch geladen uit GetCapabilities.
                            Klik op de kaart voor attributen (GetFeatureInfo).
                        </p>
                        <div id="pdokLayerList" class="pdok-layer-list">
                            <!-- Dynamisch gevuld -->
                        </div>
                        <div class="btn-group" style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="clearPdokOverlays()">üóëÔ∏è Wis Lagen</button>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>üñºÔ∏è Legenda</h3>
                        <span>‚ñº</span>
                    </div>
                    <div class="section-content open">
                        <div id="pdokLegend" class="pdok-legend">
                            <div class="pdok-legend-empty">Zet een laag aan om een legenda te zien.</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <h3>‚ÑπÔ∏è Info</h3>
                        <span>‚ñº</span>
                    </div>
                    <div class="section-content">
                        <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;">
                            <strong>KRW Oppervlaktewaterlichamen:</strong> Waterlichamen volgens de Kaderrichtlijn Water.<br><br>
                            <strong>Waterschappen:</strong> Grenzen van de Nederlandse waterschappen.<br><br>
                            <strong>GetFeatureInfo:</strong> Klik op een actieve laag op de kaart om attributen te bekijken.
                        </p>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h3>üìä Status</h3>
                    </div>
                    <div class="section-content open">
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="pdokActiveCount">0</div>
                                <div class="stat-label">Actieve Lagen</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- Einde panel-pdok -->
        </div>
        
        <div class="map-container">
            <div class="header-bar">
                <div class="header-info">
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Gereed</span>
                    </div>
                    <div class="source">
                        <strong>Bronnen:</strong> RWS WFS + DD-API
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="loadLocations()">üìç Locaties Laden</button>
                    <button class="btn btn-success" onclick="loadMeasurements()">üß™ Metingen Laden</button>
                    <button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
                </div>
            </div>
            
            <div class="filter-indicator" id="filterIndicator">
                Gefilterd op: <span id="filterName">-</span>
            </div>
            
            <div id="map"></div>
            
            <div class="legend" id="legend">
                <div class="legend-title" id="legendTitle">Concentratie</div>
                <div style="display: flex;">
                    <div class="legend-gradient"></div>
                    <div class="legend-labels">
                        <span id="legendMax">Hoog</span>
                        <span id="legendMid">-</span>
                        <span id="legendMin">Laag</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-panel" id="detailPanel">
                <div class="detail-header">
                    <div>
                        <h3 id="detailTitle">-</h3>
                        <div class="code" id="detailCode">-</div>
                    </div>
                    <button class="detail-close" onclick="closeDetailPanel()">√ó</button>
                </div>
                <div class="detail-content" id="detailContent"></div>
            </div>
            
            <!-- PDOK Feature Info Panel -->
            <div class="feature-panel" id="featurePanel">
                <button class="feature-close" onclick="closeFeaturePanel()">Sluiten</button>
                <h4 id="featureTitle">-</h4>
                <div class="feature-sub" id="featureSub">-</div>
                <div id="featureBody"></div>
            </div>
            
            <div class="loading-overlay" id="loadingOverlay">
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text" id="loadingText">Laden...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Proj4 definitie voor RD naar WGS84
        proj4.defs("EPSG:28992", "+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.417,50.3319,465.552,-0.398957,0.343988,-1.8774,4.0725 +units=m +no_defs");
        
        // PDOK Services configuratie met hardcoded layer names (GetCapabilities werkt niet vanwege CORS)
        const PDOK_SERVICES = [
            {
                id: 'krw',
                label: 'KRW Oppervlaktewaterlichamen (INSPIRE)',
                desc: 'Waterlichamen uit Kaderrichtlijn Water (geometrie + attributen)',
                wms: 'https://service.pdok.nl/ihw/krw-oppervlaktewaterlichamen-geharmoniseerd/wms/v1_0',
                defaultLayer: 'AM.WaterBodyForWFD'
            },
            {
                id: 'krw-monitoring',
                label: 'KRW Monitoringlocaties (INSPIRE)',
                desc: 'Monitoringfaciliteiten die aan EU gerapporteerd zijn (KRW)',
                wms: 'https://service.pdok.nl/ihw/krw-monitoringlocaties-geharmoniseerd/wms/v1_0',
                defaultLayer: 'EF.EnvironmentalMonitoringFacilities'
            },
            {
                id: 'waterschappen',
                label: 'Waterschapsgrenzen (IMSO)',
                desc: 'Waterschapsgebieden (beheergrenzen) volgens IMSO',
                wms: 'https://service.pdok.nl/hwh/waterschappen-waterschapsgrenzen-imso/wms/v2_0',
                defaultLayer: 'Waterschap'
            },
            {
                id: 'oppervlaktewateren',
                label: 'Oppervlaktewateren (IMWA) - Waterdeel',
                desc: 'Waterdelen uit IMWA (sloten, kanalen, wateroppervlak)',
                wms: 'https://service.pdok.nl/hwh/waterschappen-oppervlaktewateren-imwa/wms/v2_0',
                defaultLayer: 'Waterdeel'
            }
        ];
        
        // PDOK gerelateerde variabelen
        const pdokCapabilities = new Map();
        const pdokOverlays = new Map();
        let currentMainTab = 'waterkwaliteit';
        
        // Globale variabelen
        let map;
        let markersLayer;
        let geoFilterLayer;
        let allLocations = [];
        let filteredLocations = [];
        let locationData = {};
        let waterbeheerders = {};
        let provinciesGeoJSON = null;
        let gemeentenGeoJSON = null;
        let currentGeoFilter = 'alles';
        let selectedGeoArea = null;
        let selectedWaterbeheerder = null;
        let selectedParameter = 'Ptot';
        let selectedUnit = 'mg/L';
        let colorMode = 'concentratie';
        let locationColorMode = 'waterschap';
        
        // Kleuren voor waterschappen
        const WATERSCHAP_COLORS = [
            '#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6',
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
            '#14b8a6', '#a855f7', '#eab308', '#0ea5e9', '#d946ef',
            '#10b981', '#f43f5e', '#7c3aed', '#0891b2', '#65a30d',
            '#fb923c', '#a78bfa', '#2dd4bf', '#fbbf24', '#f472b6'
        ];
        
        // Kleuren voor watertypes
        const WATERTYPE_COLORS = {
            'M': '#3b82f6',  // Meren - blauw
            'R': '#22c55e',  // Rivieren - groen
            'K': '#06b6d4',  // Kustwateren - cyaan
            'O': '#f59e0b'   // Overig - oranje
        };
        let detailChart = null;
        
        // Initialisatie
        document.addEventListener('DOMContentLoaded', async () => {
            initYearSelects();
            initMap();
            await loadGeoData();
            setupEventListeners();
            
            // PDOK initialisatie
            buildPdokLayerList();
        });
        
        function initYearSelects() {
            const currentYear = new Date().getFullYear();
            const yearFrom = document.getElementById('yearFrom');
            const yearTo = document.getElementById('yearTo');
            
            for (let y = currentYear; y >= 2000; y--) {
                yearFrom.add(new Option(y, y, y === currentYear - 1, y === currentYear - 1));
                yearTo.add(new Option(y, y, y === currentYear, y === currentYear));
            }
        }
        
        function initMap() {
            map = L.map('map', { center: [52.1, 5.1], zoom: 8 });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            geoFilterLayer = L.layerGroup().addTo(map);
            
            // Click handler voor PDOK GetFeatureInfo
            map.on('click', onPdokMapClick);
        }
        
        async function loadGeoData() {
            try {
                const [provRes, gemRes] = await Promise.all([
                    fetch('https://cartomap.github.io/nl/wgs84/provincie_2024.geojson'),
                    fetch('https://cartomap.github.io/nl/wgs84/gemeente_2024.geojson')
                ]);
                provinciesGeoJSON = await provRes.json();
                gemeentenGeoJSON = await gemRes.json();
                
                const gemeenteSelect = document.getElementById('gemeenteSelect');
                gemeenteSelect.innerHTML = '<option value="">Kies een gemeente...</option>';
                gemeentenGeoJSON.features
                    .map(f => f.properties.statnaam)
                    .filter(n => n)
                    .sort()
                    .forEach(g => gemeenteSelect.add(new Option(g, g)));
            } catch (e) {
                console.error('Fout bij laden geo data:', e);
            }
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.param-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.param-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedParameter = item.dataset.code;
                    selectedUnit = item.dataset.unit;
                });
            });
            
            document.getElementById('gemeenteSearch').addEventListener('input', (e) => {
                const search = e.target.value.toLowerCase();
                const select = document.getElementById('gemeenteSelect');
                Array.from(select.options).forEach(opt => {
                    if (opt.value === '') return;
                    opt.style.display = opt.textContent.toLowerCase().includes(search) ? '' : 'none';
                });
            });
        }
        
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span:last-child');
            content.classList.toggle('open');
            arrow.textContent = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
        }
        
        function setGeoFilter(type) {
            currentGeoFilter = type;
            document.querySelectorAll('.geo-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase().includes(type.substring(0, 4)));
            });
            document.querySelectorAll('.geo-content').forEach(c => c.classList.remove('active'));
            document.getElementById('geo' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
        }
        
        function selectWaterbeheerder(code, name) {
            selectedWaterbeheerder = code;
            document.querySelectorAll('.waterbeheerder-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.code === code);
            });
        }
        
        async function applyGeoFilter() {
            geoFilterLayer.clearLayers();
            selectedGeoArea = null;
            selectedWaterbeheerder = null;
            
            const filterIndicator = document.getElementById('filterIndicator');
            const filterName = document.getElementById('filterName');
            
            if (currentGeoFilter === 'alles') {
                filterIndicator.classList.remove('visible');
                filterLocations();
                return;
            }
            
            if (currentGeoFilter === 'waterschap') {
                const selected = document.querySelector('.waterbeheerder-item.selected');
                if (selected) {
                    selectedWaterbeheerder = selected.dataset.code;
                    filterName.textContent = selected.dataset.name;
                    filterIndicator.classList.add('visible');
                }
            }
            
            if (currentGeoFilter === 'provincie') {
                const provinceName = document.getElementById('provincieSelect').value;
                if (provinceName && provinciesGeoJSON) {
                    const feature = provinciesGeoJSON.features.find(f => f.properties.statnaam === provinceName);
                    if (feature) {
                        selectedGeoArea = feature;
                        filterName.textContent = provinceName;
                        filterIndicator.classList.add('visible');
                        L.geoJSON(feature, { style: { color: '#3b82f6', weight: 3, fillOpacity: 0.1 } }).addTo(geoFilterLayer);
                        map.fitBounds(L.geoJSON(feature).getBounds(), { padding: [50, 50] });
                    }
                }
            }
            
            if (currentGeoFilter === 'gemeente') {
                const gemeenteName = document.getElementById('gemeenteSelect').value;
                if (gemeenteName && gemeentenGeoJSON) {
                    const feature = gemeentenGeoJSON.features.find(f => f.properties.statnaam === gemeenteName);
                    if (feature) {
                        selectedGeoArea = feature;
                        filterName.textContent = gemeenteName;
                        filterIndicator.classList.add('visible');
                        L.geoJSON(feature, { style: { color: '#3b82f6', weight: 3, fillOpacity: 0.1 } }).addTo(geoFilterLayer);
                        map.fitBounds(L.geoJSON(feature).getBounds(), { padding: [50, 50] });
                    }
                }
            }
            
            filterLocations();
        }
        
        function filterLocations() {
            filteredLocations = allLocations.filter(loc => {
                if (selectedWaterbeheerder) {
                    return loc.properties.WaterbeheerderCode === selectedWaterbeheerder;
                }
                if (selectedGeoArea) {
                    const point = turf.point([loc.wgs84.lng, loc.wgs84.lat]);
                    return turf.booleanPointInPolygon(point, selectedGeoArea);
                }
                return true;
            });
            updateMap();
            updateStats();
        }
        
        async function loadLocations() {
            showLoading('Meetlocaties ophalen van RWS WFS...');
            
            try {
                const maxLocations = document.getElementById('maxLocations').value;
                const response = await fetch(
                    'https://geo.rijkswaterstaat.nl/services/ogc/wkp/wkp/wfs?' +
                    'service=WFS&version=2.0.0&request=GetFeature&' +
                    'typeName=wkp:LEWmeetobjecten&outputFormat=application/json&count=' + maxLocations
                );
                const data = await response.json();
                
                setLoadingText(`${data.features.length.toLocaleString()} locaties verwerken...`);
                
                allLocations = data.features.map(f => {
                    const props = f.properties;
                    let wgs84 = { lat: 52.1, lng: 5.1 };
                    if (props.GeometriePuntX_RD && props.GeometriePuntY_RD) {
                        const conv = proj4("EPSG:28992", "EPSG:4326", [props.GeometriePuntX_RD, props.GeometriePuntY_RD]);
                        wgs84 = { lng: conv[0], lat: conv[1] };
                    }
                    return { ...f, wgs84 };
                });
                
                // Verzamel waterbeheerders
                waterbeheerders = {};
                allLocations.forEach(loc => {
                    const code = loc.properties.WaterbeheerderCode;
                    const name = loc.properties.WaterbeheerderNaam;
                    if (code && name) {
                        if (!waterbeheerders[code]) waterbeheerders[code] = { name, count: 0 };
                        waterbeheerders[code].count++;
                    }
                });
                
                updateWaterbeheerderList();
                filterLocations();
                setStatus(`${allLocations.length.toLocaleString()} locaties geladen`);
                
            } catch (e) {
                console.error('Fout:', e);
                setStatus('Fout bij laden');
                alert('Fout bij laden: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        function updateWaterbeheerderList() {
            const list = document.getElementById('waterbeheerderList');
            list.innerHTML = '';
            
            Object.entries(waterbeheerders)
                .sort((a, b) => a[1].name.localeCompare(b[1].name))
                .forEach(([code, info]) => {
                    const item = document.createElement('div');
                    item.className = 'waterbeheerder-item';
                    item.dataset.code = code;
                    item.dataset.name = info.name;
                    item.innerHTML = `${info.name} <span class="count">${info.count.toLocaleString()}</span>`;
                    item.onclick = () => selectWaterbeheerder(code, info.name);
                    list.appendChild(item);
                });
        }
        
        async function loadMeasurements() {
            if (filteredLocations.length === 0) {
                alert('Laad eerst locaties en pas eventueel een filter toe.');
                return;
            }
            
            showLoading(`Metingen ophalen voor ${selectedParameter}...`);
            
            try {
                const yearFrom = document.getElementById('yearFrom').value;
                const monthFrom = document.getElementById('monthFrom').value;
                const yearTo = document.getElementById('yearTo').value;
                const monthTo = document.getElementById('monthTo').value;
                const maxResults = document.getElementById('maxResults').value;
                
                const startDate = `${yearFrom}-${String(monthFrom).padStart(2, '0')}-01`;
                const endDate = `${yearTo}-${String(monthTo).padStart(2, '0')}-31`;
                
                // Bouw API query met contains filter (werkt beter dan eq)
                let filter = `contains(Parameter/Parameter,'${selectedParameter}')`;
                filter += ` and ResultTime ge ${startDate}T00:00:00Z`;
                filter += ` and ResultTime le ${endDate}T23:59:59Z`;
                
                const url = `https://ddapi.aquadesk.nl/v3/odata/observations?$filter=${encodeURIComponent(filter)}&$top=${maxResults}`;
                
                console.log('Fetching measurements:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                setLoadingText(`${data.value?.length || 0} metingen verwerken...`);
                
                // Verwerk metingen
                locationData = {};
                let totalMeasurements = 0;
                
                (data.value || []).forEach(obs => {
                    const geo = obs.Foi?.Geography;
                    if (!geo || !geo.coordinates) return;
                    
                    const coords = geo.coordinates;
                    const key = `${coords[0].toFixed(4)}_${coords[1].toFixed(4)}`;
                    
                    if (!locationData[key]) {
                        locationData[key] = {
                            coords: { lng: coords[0], lat: coords[1] },
                            code: obs.Foi?.Code || 'Onbekend',
                            name: obs.Foi?.Description || 'Onbekend',
                            measurements: []
                        };
                    }
                    
                    locationData[key].measurements.push({
                        date: obs.ResultTime,
                        value: obs.Result?.Measure?.Value,
                        quality: 'OK'
                    });
                    totalMeasurements++;
                });
                
                // Bereken statistieken per locatie
                Object.values(locationData).forEach(loc => {
                    const values = loc.measurements.map(m => m.value).filter(v => v != null);
                    if (values.length > 0) {
                        loc.avg = values.reduce((a, b) => a + b, 0) / values.length;
                        loc.max = Math.max(...values);
                        loc.min = Math.min(...values);
                        loc.count = values.length;
                    }
                });
                
                updateMapWithMeasurements();
                updateStats();
                setStatus(`${totalMeasurements.toLocaleString()} metingen geladen`);
                
            } catch (e) {
                console.error('Fout:', e);
                setStatus('Fout bij laden metingen');
                alert('Fout bij laden metingen: ' + e.message);
            } finally {
                hideLoading();
            }
        }
        
        function updateMap() {
            markersLayer.clearLayers();
            
            // Maak een mapping van waterbeheerder code naar kleur
            const wbColorMap = {};
            Object.keys(waterbeheerders).forEach((code, index) => {
                wbColorMap[code] = WATERSCHAP_COLORS[index % WATERSCHAP_COLORS.length];
            });
            
            filteredLocations.forEach(loc => {
                const props = loc.properties;
                
                let color;
                if (locationColorMode === 'waterschap') {
                    color = wbColorMap[props.WaterbeheerderCode] || '#888888';
                } else {
                    const typeCode = (props.KRWWatertypeCode || 'O').charAt(0);
                    color = WATERTYPE_COLORS[typeCode] || WATERTYPE_COLORS['O'];
                }
                
                const marker = L.circleMarker([loc.wgs84.lat, loc.wgs84.lng], {
                    radius: 6,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                marker.on('click', () => showLocationDetail(loc));
                marker.addTo(markersLayer);
            });
            
            document.getElementById('statLocaties').textContent = filteredLocations.length.toLocaleString();
            updateLocationLegend();
        }
        
        function updateMapWithMeasurements() {
            markersLayer.clearLayers();
            
            const allValues = Object.values(locationData).map(l => l.avg).filter(v => v != null);
            if (allValues.length === 0) {
                console.log('Geen meetwaarden om te tonen');
                return;
            }
            
            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);
            
            // Herstel de gradient legenda
            restoreGradientLegend(minVal, maxVal);
            
            Object.entries(locationData).forEach(([key, loc]) => {
                const color = getColorForValue(loc.avg, minVal, maxVal);
                
                const marker = L.circleMarker([loc.coords.lat, loc.coords.lng], {
                    radius: 7,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1.5,
                    opacity: 1,
                    fillOpacity: 0.85
                });
                
                marker.bindTooltip(`${loc.name}<br>${selectedParameter}: ${loc.avg?.toFixed(3) || '-'} ${selectedUnit}`, {
                    permanent: false,
                    direction: 'top'
                });
                
                marker.on('click', () => showMeasurementDetail(loc));
                marker.addTo(markersLayer);
            });
            
            document.getElementById('statLocaties').textContent = Object.keys(locationData).length.toLocaleString();
        }
        
        function getColorForValue(value, min, max) {
            if (value == null) return '#888888';
            
            const range = max - min || 1;
            let ratio;
            
            if (colorMode === 'percentiel') {
                const allValues = Object.values(locationData).map(l => l.avg).filter(v => v != null).sort((a, b) => a - b);
                const index = allValues.findIndex(v => v >= value);
                ratio = index / allValues.length;
            } else {
                ratio = (value - min) / range;
            }
            
            // Blauw (laag) -> Groen -> Geel -> Oranje -> Rood (hoog)
            const colors = [
                { pos: 0, r: 59, g: 130, b: 246 },    // Blauw
                { pos: 0.25, r: 34, g: 197, b: 94 },  // Groen
                { pos: 0.5, r: 234, g: 179, b: 8 },   // Geel
                { pos: 0.75, r: 249, g: 115, b: 22 }, // Oranje
                { pos: 1, r: 239, g: 68, b: 68 }      // Rood
            ];
            
            let c1 = colors[0], c2 = colors[colors.length - 1];
            for (let i = 0; i < colors.length - 1; i++) {
                if (ratio >= colors[i].pos && ratio <= colors[i + 1].pos) {
                    c1 = colors[i];
                    c2 = colors[i + 1];
                    break;
                }
            }
            
            const localRatio = (ratio - c1.pos) / (c2.pos - c1.pos || 1);
            const r = Math.round(c1.r + (c2.r - c1.r) * localRatio);
            const g = Math.round(c1.g + (c2.g - c1.g) * localRatio);
            const b = Math.round(c1.b + (c2.b - c1.b) * localRatio);
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        function showLocationDetail(location) {
            const panel = document.getElementById('detailPanel');
            const props = location.properties;
            
            document.getElementById('detailTitle').textContent = props.Omschrijving || 'Onbekend';
            document.getElementById('detailCode').textContent = props.MeetobjectCode || '-';
            
            document.getElementById('detailContent').innerHTML = `
                <div class="detail-stats">
                    <div class="detail-stat" style="grid-column: span 2;">
                        <div class="detail-stat-value">${props.WaterbeheerderNaam || '-'}</div>
                        <div class="detail-stat-label">Waterbeheerder</div>
                    </div>
                    <div class="detail-stat" style="grid-column: span 2;">
                        <div class="detail-stat-value">${props.KRWWatertypeCode || '-'}</div>
                        <div class="detail-stat-label">KRW Watertype</div>
                    </div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary);">
                    Klik op "Metingen Laden" om meetwaarden voor deze locatie te zien.
                </p>
                <table class="measurements-table" style="margin-top: 1rem;">
                    <tr><td style="color: var(--text-secondary);">Waterbeheerder</td><td>${props.WaterbeheerderNaam || '-'}</td></tr>
                    <tr><td style="color: var(--text-secondary);">Watergangcategorie</td><td>${props.WatergangcategorieOmschrijving || '-'}</td></tr>
                    <tr><td style="color: var(--text-secondary);">KRW Watertype</td><td>${props.KRWWatertypeOmschrijving || '-'}</td></tr>
                    <tr><td style="color: var(--text-secondary);">Co√∂rdinaten</td><td>${location.wgs84.lat.toFixed(5)}, ${location.wgs84.lng.toFixed(5)}</td></tr>
                </table>
            `;
            
            panel.classList.add('visible');
        }
        
        function showMeasurementDetail(loc) {
            const panel = document.getElementById('detailPanel');
            
            document.getElementById('detailTitle').textContent = loc.name;
            document.getElementById('detailCode').textContent = loc.code;
            
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="detail-stats">
                    <div class="detail-stat">
                        <div class="detail-stat-value">${loc.avg?.toFixed(3) || '-'}</div>
                        <div class="detail-stat-label">Gemiddelde</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value">${loc.max?.toFixed(3) || '-'}</div>
                        <div class="detail-stat-label">Maximum</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value">${loc.min?.toFixed(3) || '-'}</div>
                        <div class="detail-stat-label">Minimum</div>
                    </div>
                    <div class="detail-stat">
                        <div class="detail-stat-value">${loc.count || 0}</div>
                        <div class="detail-stat-label">Metingen</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="detailChartCanvas"></canvas>
                </div>
                
                <h4 style="font-size: 0.85rem; margin-bottom: 0.5rem;">Laatste metingen</h4>
                <table class="measurements-table">
                    <thead>
                        <tr><th>Datum</th><th>${selectedParameter} (${selectedUnit})</th></tr>
                    </thead>
                    <tbody>
                        ${loc.measurements.slice(0, 10).map(m => `
                            <tr>
                                <td>${new Date(m.date).toLocaleDateString('nl-NL')}</td>
                                <td>${m.value?.toFixed(3) || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            panel.classList.add('visible');
            
            // Maak grafiek
            setTimeout(() => {
                const ctx = document.getElementById('detailChartCanvas');
                if (ctx) {
                    if (detailChart) detailChart.destroy();
                    
                    const sortedMeasurements = [...loc.measurements].sort((a, b) => 
                        new Date(a.date) - new Date(b.date)
                    );
                    
                    detailChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sortedMeasurements.map(m => new Date(m.date).toLocaleDateString('nl-NL')),
                            datasets: [{
                                label: `${selectedParameter} (${selectedUnit})`,
                                data: sortedMeasurements.map(m => m.value),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: true, ticks: { maxRotation: 45, font: { size: 9 } } },
                                y: { display: true, beginAtZero: true }
                            }
                        }
                    });
                }
            }, 100);
        }
        
        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('visible');
        }
        
        function updateStats() {
            // Update waterschappen count
            const uniqueWB = new Set(filteredLocations.map(l => l.properties.WaterbeheerderCode));
            document.getElementById('statWaterschappen').textContent = uniqueWB.size;
            
            const allValues = Object.values(locationData);
            const totalMeasurements = allValues.reduce((sum, l) => sum + (l.count || 0), 0);
            const avgValues = allValues.map(l => l.avg).filter(v => v != null);
            
            document.getElementById('statMetingen').textContent = totalMeasurements.toLocaleString();
            
            if (avgValues.length > 0) {
                const overallAvg = avgValues.reduce((a, b) => a + b, 0) / avgValues.length;
                const overallMax = Math.max(...avgValues);
                document.getElementById('statGemiddelde').textContent = overallAvg.toFixed(2);
            } else {
                document.getElementById('statGemiddelde').textContent = '-';
            }
        }
        
        function setColorMode(mode) {
            colorMode = mode;
            // Update alleen de metingen kleurschaal buttons
            const btns = document.querySelectorAll('.section-content.open .btn-group:nth-of-type(2) .btn');
            btns.forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(mode.substring(0, 5)));
            });
            if (Object.keys(locationData).length > 0) {
                updateMapWithMeasurements();
            }
        }
        
        function setLocationColorMode(mode) {
            locationColorMode = mode;
            document.getElementById('btnColorWaterschap').classList.toggle('active', mode === 'waterschap');
            document.getElementById('btnColorWatertype').classList.toggle('active', mode === 'watertype');
            updateMap();
        }
        
        function restoreGradientLegend(minVal, maxVal) {
            const legend = document.getElementById('legend');
            legend.innerHTML = `
                <div class="legend-title" id="legendTitle">Concentratie</div>
                <div style="display: flex;">
                    <div class="legend-gradient"></div>
                    <div class="legend-labels">
                        <span id="legendMax">${maxVal.toFixed(2)} ${selectedUnit}</span>
                        <span id="legendMid">${((minVal + maxVal) / 2).toFixed(2)} ${selectedUnit}</span>
                        <span id="legendMin">${minVal.toFixed(2)} ${selectedUnit}</span>
                    </div>
                </div>
            `;
        }
        
        function updateLocationLegend() {
            const legendTitle = document.getElementById('legendTitle');
            const legend = document.getElementById('legend');
            
            // Verberg de gradient legenda en toon waterbeheerder/watertype legenda
            if (Object.keys(locationData).length === 0) {
                // Geen metingen geladen, toon locatie legenda
                let html = `<div class="legend-title">${locationColorMode === 'waterschap' ? 'Waterbeheerder' : 'Watertype'}</div>`;
                html += '<div class="legend-scale">';
                
                if (locationColorMode === 'waterschap') {
                    // Toon alleen waterschappen die in de gefilterde data voorkomen
                    const visibleWB = new Set(filteredLocations.map(l => l.properties.WaterbeheerderCode));
                    
                    Object.entries(waterbeheerders)
                        .filter(([code]) => visibleWB.has(code))
                        .slice(0, 10)
                        .forEach(([code, info], index) => {
                            const colorIndex = Object.keys(waterbeheerders).indexOf(code);
                            const color = WATERSCHAP_COLORS[colorIndex % WATERSCHAP_COLORS.length];
                            html += `
                                <div class="legend-item">
                                    <div class="legend-color" style="background: ${color}"></div>
                                    <span>${info.name.substring(0, 25)}${info.name.length > 25 ? '...' : ''}</span>
                                </div>
                            `;
                        });
                    
                    if (visibleWB.size > 10) {
                        html += `<div class="legend-item" style="color: var(--text-secondary);">+ ${visibleWB.size - 10} meer...</div>`;
                    }
                } else {
                    // Watertype legenda
                    html += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${WATERTYPE_COLORS['M']}"></div>
                            <span>Meren</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${WATERTYPE_COLORS['R']}"></div>
                            <span>Rivieren</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${WATERTYPE_COLORS['K']}"></div>
                            <span>Kustwateren</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${WATERTYPE_COLORS['O']}"></div>
                            <span>Overig</span>
                        </div>
                    `;
                }
                
                html += '</div>';
                legend.innerHTML = html;
            }
        }
        
        function exportData() {
            const data = Object.values(locationData);
            if (data.length === 0) {
                alert('Geen data om te exporteren.');
                return;
            }
            
            const exportRows = [];
            data.forEach(loc => {
                loc.measurements.forEach(m => {
                    exportRows.push({
                        'Locatie Code': loc.code,
                        'Locatie Naam': loc.name,
                        'Parameter': selectedParameter,
                        'Datum': m.date,
                        'Waarde': m.value,
                        'Eenheid': selectedUnit,
                        'Latitude': loc.coords.lat,
                        'Longitude': loc.coords.lng
                    });
                });
            });
            
            const ws = XLSX.utils.json_to_sheet(exportRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Metingen');
            XLSX.writeFile(wb, `wkp_${selectedParameter}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('visible');
            document.getElementById('statusDot').classList.add('loading');
            document.getElementById('statusText').textContent = 'Laden...';
        }
        
        function setLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('visible');
            document.getElementById('statusDot').classList.remove('loading');
        }
        
        function setStatus(text) {
            document.getElementById('statusText').textContent = text;
        }
        
        // ==================== PDOK FUNCTIES ====================
        
        function switchMainTab(tab) {
            currentMainTab = tab;
            document.getElementById('mainTab-waterkwaliteit').classList.toggle('active', tab === 'waterkwaliteit');
            document.getElementById('mainTab-pdok').classList.toggle('active', tab === 'pdok');
            document.getElementById('panel-waterkwaliteit').classList.toggle('active', tab === 'waterkwaliteit');
            document.getElementById('panel-pdok').classList.toggle('active', tab === 'pdok');
        }
        
        async function fetchPdokCapabilities(service) {
            if (pdokCapabilities.has(service.id)) return pdokCapabilities.get(service.id);
            
            const url = `${service.wms}?service=WMS&request=GetCapabilities&version=1.3.0`;
            const result = { layerNames: [], chosenName: null, ok: false, error: null };
            
            try {
                const res = await fetch(url);
                const xmlText = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlText, 'text/xml');
                
                const hasCaps = xml.querySelector('WMS_Capabilities, WMT_MS_Capabilities');
                if (!hasCaps) {
                    result.error = 'Geen WMS capabilities ontvangen.';
                    pdokCapabilities.set(service.id, result);
                    return result;
                }
                
                const layers = Array.from(xml.querySelectorAll('Layer Layer'));
                const seen = new Set();
                layers.forEach(L => {
                    const nameNode = L.querySelector(':scope > Name');
                    const titleNode = L.querySelector(':scope > Title');
                    if (!nameNode) return;
                    const name = (nameNode.textContent || '').trim();
                    if (!name || seen.has(name)) return;
                    seen.add(name);
                    const title = titleNode ? (titleNode.textContent || '').trim() : '';
                    result.layerNames.push({ name, title });
                });
                
                let chosen = null;
                for (const needle of (service.preferredNameContains || [])) {
                    chosen = result.layerNames.find(x => (x.name.includes(needle) || (x.title || '').includes(needle)));
                    if (chosen) break;
                }
                if (!chosen && result.layerNames.length) chosen = result.layerNames[0];
                
                result.chosenName = chosen ? chosen.name : null;
                result.ok = !!result.chosenName;
            } catch (e) {
                result.error = String(e);
            }
            
            pdokCapabilities.set(service.id, result);
            return result;
        }
        
        async function buildPdokLayerList() {
            const list = document.getElementById('pdokLayerList');
            
            let html = '';
            for (const svc of PDOK_SERVICES) {
                html += `
                    <div class="pdok-layer-item">
                        <div class="pdok-layer-header">
                            <input type="checkbox" id="pdok-chk-${svc.id}" onchange="togglePdokOverlay('${svc.id}')" />
                            <div class="pdok-layer-meta">
                                <div class="pdok-layer-name">${svc.label}</div>
                                <div class="pdok-layer-desc">${svc.desc}</div>
                                <span class="pdok-layer-status ok">Beschikbaar</span>
                            </div>
                        </div>
                        <div class="pdok-layer-controls">
                            <div style="grid-column: 1 / -1;">
                                <label>Opaciteit</label>
                                <input type="range" min="0" max="100" value="70" id="pdok-op-${svc.id}" oninput="updatePdokOpacity('${svc.id}')" />
                            </div>
                        </div>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }
        
        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
        }
        
        function updatePdokActiveCount() {
            document.getElementById('pdokActiveCount').textContent = String(pdokOverlays.size);
        }
        
        function clearPdokOverlays() {
            for (const [id, obj] of pdokOverlays.entries()) {
                map.removeLayer(obj.layer);
            }
            pdokOverlays.clear();
            PDOK_SERVICES.forEach(s => {
                const chk = document.getElementById(`pdok-chk-${s.id}`);
                if (chk) chk.checked = false;
            });
            updatePdokActiveCount();
            setPdokLegend(null);
            setStatus('PDOK overlays gewist');
        }
        
        async function togglePdokOverlay(serviceId) {
            const svc = PDOK_SERVICES.find(s => s.id === serviceId);
            const chk = document.getElementById(`pdok-chk-${serviceId}`);
            if (!svc || !chk) return;
            
            if (!chk.checked) {
                const obj = pdokOverlays.get(serviceId);
                if (obj) { map.removeLayer(obj.layer); pdokOverlays.delete(serviceId); }
                updatePdokActiveCount();
                setPdokLegend(null);
                return;
            }
            
            const op = document.getElementById(`pdok-op-${serviceId}`);
            const layerName = svc.defaultLayer;
            
            const opacity = op ? (op.value / 100) : 0.7;
            
            const wmsLayer = L.tileLayer.wms(svc.wms, {
                layers: layerName,
                format: 'image/png',
                transparent: true,
                version: '1.3.0',
                opacity
            }).addTo(map);
            
            pdokOverlays.set(serviceId, { layer: wmsLayer, layerName, opacity, svc });
            updatePdokActiveCount();
            setStatus(`PDOK laag aan: ${svc.label}`);
            setPdokLegendFor(serviceId);
        }
        
        function updatePdokOpacity(serviceId) {
            const op = document.getElementById(`pdok-op-${serviceId}`);
            const obj = pdokOverlays.get(serviceId);
            if (!op) return;
            if (obj) {
                obj.opacity = op.value / 100;
                obj.layer.setOpacity(obj.opacity);
            }
        }
        
        function changePdokLayer(serviceId) {
            const obj = pdokOverlays.get(serviceId);
            const sel = document.getElementById(`pdok-sel-${serviceId}`);
            if (!sel || !obj) return;
            
            map.removeLayer(obj.layer);
            const svc = obj.svc;
            const op = document.getElementById(`pdok-op-${serviceId}`);
            const opacity = op ? op.value / 100 : 0.7;
            
            const wmsLayer = L.tileLayer.wms(svc.wms, {
                layers: sel.value,
                format: 'image/png',
                transparent: true,
                version: '1.3.0',
                opacity
            }).addTo(map);
            
            pdokOverlays.set(serviceId, { layer: wmsLayer, layerName: sel.value, opacity, svc });
            setPdokLegendFor(serviceId);
            setStatus(`PDOK layer gewijzigd: ${svc.label}`);
        }
        
        function setPdokLegend(html) {
            const box = document.getElementById('pdokLegend');
            if (!html) {
                box.innerHTML = '<div class="pdok-legend-empty">Zet een laag aan om een legenda te zien.</div>';
                return;
            }
            box.innerHTML = html;
        }
        
        function setPdokLegendFor(serviceId) {
            const obj = pdokOverlays.get(serviceId);
            if (!obj) { setPdokLegend(null); return; }
            
            const url = `${obj.svc.wms}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${encodeURIComponent(obj.layerName)}`;
            setPdokLegend('<div class="pdok-legend-empty">Legenda laden...</div>');
            
            const img = new Image();
            img.src = url;
            img.alt = 'Legenda';
            img.onload = () => {
                setPdokLegend('');
                document.getElementById('pdokLegend').appendChild(img);
            };
            img.onerror = () => setPdokLegend('<div class="pdok-legend-empty">Geen legenda beschikbaar.</div>');
        }
        
        // GetFeatureInfo voor PDOK lagen
        async function onPdokMapClick(e) {
            if (currentMainTab !== 'pdok') return;
            
            const items = Array.from(pdokOverlays.entries());
            if (items.length === 0) return;
            
            for (let i = items.length - 1; i >= 0; i--) {
                const [serviceId, obj] = items[i];
                const ok = await tryPdokFeatureInfo(obj, e.latlng);
                if (ok) return;
            }
        }
        
        async function tryPdokFeatureInfo(obj, latlng) {
            const svc = obj.svc;
            const size = map.getSize();
            const bounds = map.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            const point = map.latLngToContainerPoint(latlng);
            
            const url = `${svc.wms}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo` +
                `&LAYERS=${encodeURIComponent(obj.layerName)}&QUERY_LAYERS=${encodeURIComponent(obj.layerName)}` +
                `&INFO_FORMAT=application/json` +
                `&I=${Math.round(point.x)}&J=${Math.round(point.y)}` +
                `&WIDTH=${size.x}&HEIGHT=${size.y}` +
                `&CRS=EPSG:4326` +
                `&BBOX=${sw.lat},${sw.lng},${ne.lat},${ne.lng}`;
            
            try {
                const res = await fetch(url);
                if (!res.ok) return false;
                const data = await res.json();
                if (!data.features || data.features.length === 0) return false;
                
                const f = data.features[0];
                const props = f.properties || {};
                showFeaturePanel(svc.label, obj.layerName, props, latlng);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        function showFeaturePanel(serviceLabel, layerName, props, latlng) {
            const fp = document.getElementById('featurePanel');
            document.getElementById('featureTitle').textContent = serviceLabel;
            document.getElementById('featureSub').textContent = `Layer: ${layerName} ‚Ä¢ Locatie: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
            
            const skip = new Set(['gml_id', 'id', 'fid', 'geom', 'geometry', 'boundedBy']);
            let rows = '';
            for (const [k, v] of Object.entries(props)) {
                if (skip.has(k)) continue;
                if (v === null || v === '') continue;
                rows += `<tr><td class="k">${escapeHtml(k)}</td><td>${escapeHtml(String(v))}</td></tr>`;
            }
            if (!rows) rows = '<tr><td colspan="2" style="color:var(--text-secondary);padding:10px 6px;">Geen attributen beschikbaar.</td></tr>';
            
            document.getElementById('featureBody').innerHTML = `<table>${rows}</table>`;
            fp.style.display = 'block';
        }
        
        function closeFeaturePanel() {
            document.getElementById('featurePanel').style.display = 'none';
        }
    </script>
</body>
</html>